\documentclass[12pt]{article}
\usepackage[french]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{amsmath}
\setlength{\headheight}{36.0976pt}
\addtolength{\topmargin}{-21.0976pt}
\usepackage{pifont}
\usepackage{geometry}
\usepackage{listings}

\usepackage{ragged2e}  % Justify text


%Sousligne
\usepackage{ulem}
\usepackage{amsmath}
\usepackage{matlab-prettifier}
\usepackage{mathtools, bm}
\usepackage{amssymb, bm}

% Commandes pour vecteurs et matrices
\newcommand{\mat}[1]{\mathbf{#1}}
\newcommand{\vect}[1]{\boldsymbol{#1}}

\usepackage{xcolor}
\makeatletter
\let\ps@plain\ps@fancy
\makeatother
\def\ind{\textrm{1\kern-0.25emI}}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\definecolor{codegreen}{rgb}{0,0.6,0}
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    keywordstyle=\color{blue},
    commentstyle=\color{codegreen},
    numberstyle=\tiny\color{black},
    frame=single,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2
}
\lstset{style=mystyle}
\usepackage{amsmath}
%Sousligne
\usepackage{ulem}
%Circuit elec
\usepackage[european, straightvoltages]{circuitikz}


\usepackage{tcolorbox}
\newtcolorbox{definitionbox}[1][]{%
  colback=white,
  colframe=subsectioncolor,
  boxrule=0.5pt,
  arc=0pt,
  outer arc=0pt,
  left=2mm,
  right=2mm,
  top=1mm,
  bottom=1mm,
  title=#1
}

\newtcolorbox{theorembox}[1][]{%
  colback=white,
  colframe=sectioncolor,
  boxrule=0.5pt,
  arc=0pt,
  outer arc=0pt,
  left=2mm,
  right=2mm,
  top=1mm,
  bottom=1mm,
  title=#1
}


\usepackage[linesnumbered,ruled,vlined]{algorithm2e}
\SetKwInput{KwIn}{Entrée}
\SetKwInput{KwOut}{Sortie}

%test
%%%%%%%%%%%%%%%%%% TABLE DES MATIERES %%%%%%%
\usepackage{tocloft} % Pour la table des matieres
%Configuration de la table des matières
\renewcommand{\cftsecfont}
{\color{sectioncolor}\bfseries}
\renewcommand{\cftsecpagefont}{\color{sectioncolor}\bfseries}
\setlength{\cftsecnumwidth}{2.5em}
\cftsetindents{section}{0em}{3em}

% Pour les sous-sections
\renewcommand{\cftsubsecfont}{\color{subsectioncolor}\bfseries}
\renewcommand{\cftsubsecpagefont}{\color{subsectioncolor}\bfseries}
\setlength{\cftsubsecnumwidth}{3em}


% Pour les sous-sous-sections (même couleur, sans gras)
\renewcommand{\cftsubsubsecfont}{\color{subsectioncolor}}
\cftsetindents{subsubsection}{4em}{4.5em}
\renewcommand{\cftsubsubsecpagefont}{\color{subsectioncolor}}
\cftsetindents{subsection}{2em}{4em}
%\setlength{\cftsubsubsecnumwidth}{3.5em}


%%%%% PARTIES
\renewcommand{\cftpartfont}{\color{sectioncolor}\bfseries\Large}
\renewcommand{\cftpartpagefont}
{\color{sectioncolor}\bfseries\Large}
\cftsetindents{part}{0em}{4em}

\renewcommand{\cftbeforepartskip}{1em}
\renewcommand{\cftpartfont}{%
  \color{sectioncolor}\bfseries\Large%
  \rule{\linewidth}{0.4pt}\\%
}

\renewcommand{\cftpartpresnum}{}
\setlength{\cftpartnumwidth}{0em}
\renewcommand{\thepart}{}


\usepackage{hyperref}
\hypersetup{
    %colorlinks=true,
    linktoc=all,
    %linkcolor=sectioncolor,
    filecolor=sectioncolor,
    urlcolor=subsectioncolor,
    pdfborder={0 0 0},
}

%Pour titre plus coool
\usepackage{mdframed}
\usepackage[utf8]{inputenc}
\usepackage{booktabs} % Pour de plus jolies tableaux
\usepackage{titlesec}
% Configuration de la géométrie de la page
\geometry{a4paper, top=2cm, bottom=2cm, left=2cm, right=2cm, headheight=15pt, includeheadfoot}
% Configuration des en-têtes et des pieds de page
\pagestyle{fancy}
\fancyhf{}
\fancyhead[R]{\includegraphics[width=2.5cm]{images.png}}

%Configuration des parties
\titleformat{\part}[display]
    {\Huge\bfseries\centering\color{sectioncolor}}
    {}
    {0pt}
    {\rule{\textwidth}{1pt}\\\vspace{0.2em}}
    [\vspace{0.2em}\rule{\textwidth}{1pt}]

\titlespacing*{\part}
    {0pt}  % Espacement gauche
    {-60pt} % Espacement avant (valeur négative pour monter)
    {20pt}  % Espacement après


%%%%%%%%%% NUMERA UE %%%%%%%
\fancyhead[L]{Filtrage de Kalman}

%%%%%%%%%%%% Nom matière

\fancyfoot[L]{Gatien Séguy \& Maxime Degraeve}

\fancyfoot[R]{\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

\usepackage{xcolor}
\definecolor{sectioncolor}{rgb}{0.7, 0.1, 0.1} % Définir la couleur rouge

% Configuration des titres de sections

\titleformat{\section}
{\normalfont\Large\bfseries\color{sectioncolor}}{\thesection}{1em}{}
%{\normalfont\large\bfseries\color{sectioncolor}\MakeUppercase}{\thesection}{1em}{}

\titlespacing*{\section}{0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex}

\renewcommand{\thesection}{\Roman{section}}



%Configuration des sous titre
\usepackage{xcolor}
\definecolor{subsectioncolor}{rgb}{0, 0.51, 0.58}
% Configuration des titres des sous-sections
\titleformat{\subsection}
{\normalfont\large\bfseries\color{subsectioncolor}}{\thesubsection}{1em}{}

% Configuration des titres des sous-sous-sections
\titleformat{\subsubsection}
{\normalfont\normalsize\bfseries\color{subsectioncolor}}{\thesubsubsection}{1em}{}

\begin{comment} % BLASON 1
\usepackage{background}
\newcommand{\blasonpage}{%
  \backgroundsetup{
    scale=0.5,
    angle=0,
    opacity=0.05,
    contents={\includegraphics[width=1.2\paperwidth]{CH_ZH_logo_Kanton_court.png}}
  }
  \BgThispage
}
\end{comment}

\begin{document}
\fontsize{13pt}{15pt}\selectfont

\begin{titlepage}
\thispagestyle{empty}
%\blasonpage % BLASON 2
\begin{center}
    % ESPACE HAUT
    %\vspace*{0.8cm}

    % LES 4 LOGOS EN UNE LIGNE
    \begin{minipage}{0.48\textwidth}
        \centering
        \includegraphics[width=\linewidth]{Logo_ENS_leger(1).jpg}
    \end{minipage}
    \hfill
    \begin{minipage}{0.48\textwidth}
        \vspace{-0.4cm}
        \includegraphics[width=\linewidth]{logo_univPS.png}
    \end{minipage}

    \vspace{1.4cm}

    {\Large \textbf{ÉCOLE NORMALE SUPÉRIEURE PARIS-SACLAY}}\\
    {\small (Université Paris-Saclay)}\\[0.2cm]


        \vspace{0.3cm}
    \noindent\makebox[\textwidth]{\color{black}\rule{1\textwidth}{2pt}}\\[-1pt]
    \noindent\makebox[\textwidth]{\color{black}\rule{0.8\textwidth}{1pt}}
    \vspace{0.3cm}


    {\Huge  \color{sectioncolor} \textbf{Compte rendu de TP}}\\[0.2cm]

{\large \textbf{Matière :} \itshape Automatique non-linéaire et Filtrage de Kalman }\\[0.2cm]


    %%%% TRAIT
    \vspace{0.3cm}
    \noindent\makebox[\textwidth]{\color{black}\rule{0.8\textwidth}{1pt}}\\[-1pt]
    \noindent\makebox[\textwidth]{\color{black}\rule{1\textwidth}{2pt}}
    \vspace{0.3cm}

    %Fin Trait
    \vspace{0.1cm}
    {\LARGE \textbf{TP2 - Éstimation de la position et de la vitesse d'un mobile par filtrage de Kalman}}\\[1cm]

    \begin{tabular}{rl}
    \textbf{Nom de l'étudiant :} & Gatien Séguy \& Maxime Degraeve \\
    \textbf{Établissement :} & ENS Paris-Saclay (Département EEA) \\
    \textbf{Encadrante :} & Jean-Pierre Barbot\\
    \textbf{Date :} & \today \\
    \end{tabular}

    \vfill

\end{center}
\end{titlepage}
% \backgroundsetup{contents={}} % BLASON 3
% Sommaire

\newpage
\vspace*{0.5cm}
\tableofcontents
\newpage


% =============================================================================
% INTRODUCTION GÉNÉRALE
% =============================================================================
\section{Introduction}

Dans ce TP, on considère un mobile se déplaçant en mouvement rectiligne quasi-uniforme. L'objectif est d'estimer sa position et sa vitesse (constituant son état) à partir de la seule mesure bruitée de sa position. Le caractère "quasi-uniforme" du mouvement se traduit par une accélération non nulle mais de faible amplitude, modélisée comme un bruit blanc.

\bigskip 

Ce problème est représentatif de nombreuses applications pratiques : suivi de cibles radar, localisation GPS, ou encore navigation de véhicules autonomes.

\bigskip 

Les objectifs de ce travail pratique sont les suivants :
\begin{itemize}
    \item Mettre en équation le système sous forme d'un modèle d'état à temps discret, en identifiant les matrices du système et les statistiques des bruits.
    \item Implémenter le filtre de Kalman et illustrer son fonctionnement sur des données simulées.
    \item Étudier l'influence de différents paramètres sur les performances du filtre : nature de la densité de probabilité des bruits, initialisation du filtre, et erreurs de modélisation sur les matrices de covariance.
\end{itemize}

\bigskip

On adopte les notations suivantes tout au long du CR (je prefère radoter pour pas me perdre dans les notations / indices) :
\begin{itemize}
    \item $t_k = kT$ : instants d'échantillonnage avec $T > 0$ la période d'échantillonnage
    \item $d_k$ : position du mobile à l'instant $t_k$
    \item $v_k$ : vitesse du mobile à l'instant $t_k$
    \item $\gamma_k$ : accélération du mobile sur l'intervalle $[t_k, t_{k+1}]$
    \item $\mat{x}_k = (d_k \; v_k)^T$ : vecteur d'état
    \item $y_k$ : mesure de la position à l'instant $t_k$
    \item $w_k$ : bruit de mesure
    \item $\sigma_\gamma$ : écart-type de l'accélération ($\sigma_\gamma = 0{,}01$ m/s$^2$)
    \item $\sigma_d$ : écart-type du bruit de mesure ($\sigma_d = 0{,}1$ m)
\end{itemize}


\section{Modèle du système}
\subsection{Préparation 1}

\subsubsection{Dynamique continue du système}

On considère un mobile en mouvement rectiligne. Pour $t \geq kT$, les équations de la cinématique donnent :
\[
\begin{cases}
v(t) = v_k + \displaystyle\int_{kT}^{t} \gamma(\tau)\, d\tau \\[2ex]
d(t) = d_k + \displaystyle\int_{kT}^{t} v(\tau)\, d\tau
\end{cases}
\]

\subsubsection{Discrétisation avec accélération constante par morceaux}

Entre deux instants d'échantillonnage consécutifs, l'accélération est supposée constante : pour $t \in [kT, (k+1)T]$, on a $\gamma(t) = \gamma_k$.

En intégrant, on obtient l'évolution de la vitesse :
\[
v(t) = v_k + \gamma_k (t - kT)
\]

Puis, en intégrant la vitesse, on obtient l'évolution de la position :
\[
d(t) = d_k + \int_{kT}^{t} \left[ v_k + \gamma_k (\tau - kT) \right] d\tau = d_k + v_k (t - kT) + \frac{\gamma_k}{2} (t - kT)^2
\]

\subsubsection{Équations aux instants d'échantillonnage}

En évaluant ces expressions à l'instant $t = (k+1)T$, on obtient les équations récurrentes :
\[
\boxed{
\begin{cases}
d_{k+1} = d_k + v_k T + \dfrac{\gamma_k T^2}{2} \\[2ex]
v_{k+1} = v_k + \gamma_k T
\end{cases}
}
\]

\subsubsection{Représentation d'état}

En définissant le vecteur d'état $\mat{x}_k = \begin{pmatrix} d_k \\ v_k \end{pmatrix}$, on peut écrire le système sous forme matricielle :
\[
\mat{x}_{k+1} = \underbrace{\begin{pmatrix} 1 & T \\ 0 & 1 \end{pmatrix}}_{\mat{A}} \mat{x}_k + \underbrace{\begin{pmatrix} \frac{T^2}{2} \\[1ex] T \end{pmatrix}}_{\mat{B}} \gamma_k
\]

Le bruit d'état est donc $\mat{b}_k = \mat{B} \gamma_k$ où $\gamma_k$ est un bruit blanc de variance $\sigma_\gamma^2$.

\subsubsection{Matrice de covariance du bruit d'état}

La matrice de covariance du bruit d'état se calcule comme suit :
\[
\mat{Q} = \mathbb{E}\left[\mat{b}_k \mat{b}_k^T\right] = \mathbb{E}\left[\mat{B} \gamma_k \gamma_k^T \mat{B}^T\right] = \mat{B} \, \mathbb{E}\left[\gamma_k^2\right] \mat{B}^T = \sigma_\gamma^2 \, \mat{B} \mat{B}^T
\]

En développant le produit $\mat{B} \mat{B}^T$ :
\[
\mat{B} \mat{B}^T = \begin{pmatrix} \frac{T^2}{2} \\[1ex] T \end{pmatrix} \begin{pmatrix} \frac{T^2}{2} & T \end{pmatrix} = \begin{pmatrix} \frac{T^4}{4} & \frac{T^3}{2} \\[1ex] \frac{T^3}{2} & T^2 \end{pmatrix}
\]

D'où la matrice de covariance du bruit d'état :
\[
\boxed{
\mat{Q} = \sigma_\gamma^2 \begin{pmatrix} \frac{T^4}{4} & \frac{T^3}{2} \\[1ex] \frac{T^3}{2} & T^2 \end{pmatrix}
}
\]

\subsubsection{Équation d'observation}

La mesure $y_k$ correspond à la position bruitée du mobile :
\[
y_k = d_k + w_k = \underbrace{\begin{pmatrix} 1 & 0 \end{pmatrix}}_{\mat{C}} \mat{x}_k + w_k
\]

où $w_k$ est un bruit blanc de variance $\sigma_d^2$.

La matrice de covariance du bruit d'observation est donc :
\[
\boxed{R = \sigma_d^2}
\]

\subsubsection{Récapitulatif du modèle d'état}

Le système à temps discret s'écrit sous la forme canonique :
\[
\boxed{
\begin{cases}
\mat{x}_{k+1} = \mat{A} \mat{x}_k + \mat{b}_k \\[1ex]
y_k = \mat{C} \mat{x}_k + w_k
\end{cases}
}
\]

avec les matrices et les statistiques des bruits :
\[
\mat{A} = \begin{pmatrix} 1 & T \\ 0 & 1 \end{pmatrix}, \quad
\mat{C} = \begin{pmatrix} 1 & 0 \end{pmatrix}
\]
\[
\mathbb{E}[\mat{b}_k] = \mat{0}, \quad \mathbb{E}[\mat{b}_k \mat{b}_k^T] = \mat{Q}, \quad
\mathbb{E}[w_k] = 0, \quad \mathbb{E}[w_k^2] = R
\]

\section{Éstimation de l'état du système}
\subsection{Préparation 2}



\subsection{Manipulation}

\subsubsection{Structure generale du programme \texttt{exemple\_FK.m}}

Le programme principal \texttt{exemple\_FK.m} est organise sous forme de menu interactif proposant huit options d'etude. Il est accompagne de trois fonctions auxiliaires :
\begin{itemize}
    \item \texttt{nuage\_n.m} : etude statistique avec bruits gaussiens
    \item \texttt{nuage\_u.m} : etude statistique avec bruits uniformes
    \item \texttt{trace\_ellipse\_P.m} : trace d'ellipses de covariance
\end{itemize}

\paragraph{Initialisation et modele du systeme}

La premiere partie du programme definit les parametres du modele conformement a la preparation 1 :

\begin{lstlisting}[language=Matlab]
T = 1;                    % Periode d'echantillonnage (s)
v_0 = 1; m_0 = [0;v_0];   % Etat initial moyen
P_0 = 100*I;              % Covariance initiale

A = [1 T; 0 1];           % Matrice d'etat
V = [T^2/2; T];           % Matrice du bruit d'etat
std_g = 0.01;             % Ecart-type acceleration (m/s^2)
Q = std_g^2*V*V';         % Covariance bruit d'etat

C = [1 0];                % Matrice d'observation
std_w = 0.1*v_0*T;        % Ecart-type bruit de mesure (m)
R = std_w^2;              % Covariance bruit d'observation
\end{lstlisting}

\paragraph{Options du menu}

Le programme propose huit options d'etude :

\begin{enumerate}
    \item \textbf{Illustration du fonctionnement du FK} : simulation d'une trajectoire et comparaison des estimations
    \item \textbf{Etude statistique (bruits gaussiens)} : validation Monte-Carlo avec $N = 10000$ trajectoires
    \item \textbf{Effet de la ddp (bruits uniformes)} : verification de la robustesse aux bruits non-gaussiens
    \item \textbf{Effet de l'etat initial} : convergence avec initialisation erronee
    \item \textbf{Effet de la covariance initiale} : influence de $\mat{P}_0$
    \item \textbf{Effet de l'erreur sur $\mat{Q}$} : consequences d'une erreur sur la covariance du bruit d'etat
    \item \textbf{Effet de l'erreur sur $R$} : consequences d'une erreur sur la covariance du bruit d'observation
    \item \textbf{Test de coherence} : distance de Mahalanobis de l'innovation
\end{enumerate}

\paragraph{Implementation du filtre de Kalman}

Le coeur du programme est la boucle du filtre de Kalman :

\begin{lstlisting}[language=Matlab]
for k = 1:k_max-1
    % Prediction
    x_pred(:,k+1) = A*x_est(:,k);
    P = A*P*A' + Q;

    % Gain de Kalman
    K = P*C'*inv(C*P*C' + R);

    % Correction
    P = (I - K*C)*P;
    y_pred(k+1) = C*x_pred(:,k+1);
    x_est(:,k+1) = x_pred(:,k+1) + K*(y(k+1) - y_pred(k+1));
end
\end{lstlisting}

\paragraph{Fonctions auxiliaires}

\begin{itemize}
    \item \texttt{trace\_ellipse\_P(Centre, P, couleur)} : trace une ellipse de covariance par diagonalisation de $\mat{P}$
    \item \texttt{nuage\_n(...)} : etude Monte-Carlo avec bruits gaussiens (\texttt{randn})
    \item \texttt{nuage\_u(...)} : etude Monte-Carlo avec bruits uniformes (\texttt{rand})
\end{itemize}

% ===========================================================================
\subsubsection{Illustration du fonctionnement du filtre de Kalman}
% ===========================================================================




\end{document}
